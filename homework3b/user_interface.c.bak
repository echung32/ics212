/*****************************************************************
//
//  NAME:        Ethan Chung
//
//  HOMEWORK:    3b
//
//  CLASS:       ICS 212
//
//  INSTRUCTOR:  Ravi Narayan
//
//  DATE:        February 6, 2023
//
//  FILE:        user_interface.c
//
//  DESCRIPTION:
//   This is the user interface component to the
//   bank database application, which handles data
//   entry and parsing of that data to be added
//   into the database.
//
 ****************************************************************/

#include <stdio.h>
#include <string.h>
#include "record.h"
#include "database.h"

void getaddress(char address[], int length);

int debugmode = 0;

/*****************************************************************
//
//  Function name: main
//
//  DESCRIPTION:   This is the entrypoint to the user interface,
//                 which handles validation of user input and has
//                 auto-complete for command options. For debugging,
//                 the user can pass in the "debug" parameter to
//                 see what is being done in the database.
//
//  Parameters:    argc (int) : The number of elements in argv
//                 argv (char*[]) : An array of arguments passed
//                                  to the program.
//
//  Return values:  1 : success
//
 ****************************************************************/

int main(int argc, char* argv[])
{
    struct record * start = NULL;
    char option[100];
    int quit = 0;

    struct record temprecord;
    char buffer[100];
    int scannerresult = 0;
    int successful = 0;

    /** Handle Debug Mode */
    if (argc > 1)
    {
        /** Handle when more than 2 arguments */
        if (argc > 2)
        {
            quit = 1;
        }
        /** Handle exact "debug" match */
        else if (strlen(argv[1]) == 5 && strncmp(argv[1], "debug", 5) == 0)
        {
            printf("** DEBUG MODE ENABLED **\n");
            debugmode = 1;
        }
        /** Handle when 2nd argument is invalid */
        else
        {
            quit = 1;
        }

        /** Handle error message */
        if (quit == 1)
        {
            printf("** ERROR: Invalid arguments!\n");
        }
    }

    if (quit == 0)
    {
        printf("Welcome, banker!");
        printf(" This program allows you to easily find");
        printf(" and manage customer bank records stored on the database.\n\n");
    }
    while (quit == 0)
    {
        printf(">> What do you want to do?\n");
        printf("- add: add a new record in the database\n");
        printf("- printall: print all records in the database\n");
        printf("- find: find record(s) with a specified account #\n");
        printf("- delete: delete existing record(s) from the");
        printf(" database using the account # as a key\n");
        printf("- quit: quit the program\n");
        printf("> ");

        fgets(option, 100, stdin);
        option[strcspn(option, "\n")] = 0;

        if (strlen(option) != 0 && strncmp(option, "add", strlen(option)) == 0)
        {
            printf("\n>> You are adding a new account.\n");

            /** Account number */
            do
            {
                printf("> Enter account number: ");
                /** Ask user input, up to 99 chars */
                scanf("%99s", buffer);
                /** Look for a digit in the buffer, then set it to number. */
                scannerresult = sscanf(buffer, "%d", &temprecord.accountno);

                if (scannerresult != 1 || (scannerresult == 1 && temprecord.accountno <= 0))
                {
                    /** Cleanup input buffer */
                    while ((fgetc(stdin)) != '\n');

                    printf("!! Account numbers must be integers >= 0. Please try again.\n\n");
                }
                else
                {
                    successful = 1;
                }
            }
            while (successful == 0);

            /** Name */
            successful = 0;
            /** Clearing buffer by setting all values to 0. */
            memset(&buffer, 0, sizeof(buffer));
            /** To read and void the newline character after scanf() */
            while ((fgetc(stdin)) != '\n');
            do
            {
                printf("> Enter customer name: ");
                /** Ask user input, up to 29 chars */
                fgets(temprecord.name, 30, stdin);
                /** Remove newline from buffer result */
                temprecord.name[strcspn(temprecord.name, "\n")] = 0;

                if (strlen(temprecord.name) == 0)
                {
                    /** Cleanup input buffer */
                    while ((fgetc(stdin)) != '\n');

                    printf("!! You must input at least one character. Please try again.");
                }
                else
                {
                    successful = 1;
                }
            }
            while (successful == 0);

            /** Address */
            /** Clearing buffer by setting all values to 0. */
            memset(&buffer, 0, sizeof(buffer));
            printf("> Enter customer address below.\n");
            printf("- Maximum of 50 characters. You can input more, but it will be ignored.\n");
            printf("- Stop input by pressing 'ENTER -> CTRL+D'.\n");
            getaddress(buffer, 50);
            strcpy(temprecord.address, buffer);

            /** Add to database */
            addRecord(&start, temprecord.accountno, temprecord.name, temprecord.address);
            printf(">> You've added a new account.\n\n");

            /** Reset variables -- clears the data by setting the values to 0. */
            successful = 0;
            memset(&temprecord, 0, sizeof(temprecord));
            memset(&buffer, 0, sizeof(buffer));
        }
        else if (strlen(option) != 0 && strncmp(option, "printall", strlen(option)) == 0)
        {
            printf(">> You are printing all accounts.\n");
            printAllRecords(start);
            printf(">> All records have been printed.\n\n");
        }
        else if (strlen(option) != 0 && strncmp(option, "find", strlen(option)) == 0)
        {
            printf(">> You are finding an account.\n");
            /** Account number */
            do
            {
                printf("> Enter account number: ");
                /** Ask user input, up to 99 chars */
                scanf("%99s", buffer);
                /** Look for a digit in the buffer, then set it to number. */
                scannerresult = sscanf(buffer, "%d", &temprecord.accountno);

                if (scannerresult != 1 || (scannerresult == 1 && temprecord.accountno <= 0))
                {
                    /** Cleanup input buffer */
                    while ((fgetc(stdin)) != '\n');

                    printf("!! Account numbers must be integers >= 0. Please try again.\n\n");
                }
                else
                {
                    successful = 1;
                }
            }
            while (successful == 0);
            /** Find record in database */
            findRecord(start, temprecord.accountno);
            printf(">> You've found an account.\n\n");

            /** Remove trailing newline character after scanf */
            while ((fgetc(stdin)) != '\n');
            /** Reset variables -- clears the data by setting the values to 0. */
            successful = 0;
            memset(&temprecord, 0, sizeof(temprecord));
            memset(&buffer, 0, sizeof(buffer));
        }
        else if (strlen(option) != 0 && strncmp(option, "delete", strlen(option)) == 0)
        {
            printf(">> You are deleting an account.\n");
            /** Account number */
            do
            {
                printf("> Enter account number: ");
                /** Ask user input, up to 99 chars */
                scanf("%99s", buffer);
                /** Look for a digit in the buffer, then set it to number. */
                scannerresult = sscanf(buffer, "%d", &temprecord.accountno);

                if (scannerresult != 1 || (scannerresult == 1 && temprecord.accountno <= 0))
                {
                    /** Cleanup input buffer */
                    while ((fgetc(stdin)) != '\n');

                    printf("!! Account numbers must be integers >= 0. Please try again.\n\n");
                }
                else
                {
                    successful = 1;
                }
            }
            while (successful == 0);
            /** Delete record in database */
            deleteRecord(&start, temprecord.accountno);
            printf(">> You have deleted an account.\n\n");
            /** Remove trailing newline character after scanf */
            while ((fgetc(stdin)) != '\n');
            /** Reset variables -- clears the data by setting the values to 0. */
            successful = 0;
            memset(&temprecord, 0, sizeof(temprecord));
            memset(&buffer, 0, sizeof(buffer));
        }
        else if (strlen(option) != 0 && strncmp(option, "quit", strlen(option)) == 0)
        {
            printf(">> Goodbye, banker!\n");
            quit = 1;
        }
        else
        {
            /** Cleanup stdin */
            if (strlen(option) > 0)
            {
                while ((fgetc(stdin)) != '\n');
            }

            printf("!! Invalid option. Please try again!\n\n");
        }
    }

    return 1;
}

/*****************************************************************
//
//  Function name: getaddress
//
//  DESCRIPTION:   This helper function accepts a multi-line
//                 input from the user and stores the value
//                 into the address pointer. The primary purpose
//                 is to accept the inputted address.
//
//  Parameters:    address (char[]) : A pointer to store the customer's address.
//                 length (int) : The maximum length of the address.
//
//  Return values:  void
//
 ****************************************************************/

void getaddress(char address[], int length)
{
    int index = 0;
    int ch; /** Holds current getchar'd character */

    if (debugmode == 1)
    {
        printf("** START * getaddress **\n");
        printf("* address: %s\n", address);
        printf("*  length: %d\n", length);
        printf("**  END  * getaddress **\n");
    }

    /**
     * Keep track of an index in order to add into the address properly,
     * and to ensure the size is length - 1 (for last '/0' character).
     */

    while ((ch = fgetc(stdin)) != EOF)
    {
        if (index < length - 1)
        {
            address[index] = ch;
            index = index + 1;
        }
    }
}
